# 线程池

## 1、线程池的参数

## 2、线程池的执行流程

## 3、线程池的CTL 属性

~~~
 1、CTL 是线程池的一个属性，本质是一个 Int 值。
 2、高 3 位 标识线程池的状态，低 29 位标识 现存工作线程数。
~~~

## 4、线程池的状态

~~~
1、（-1）Runing：线程池在正常工作，可以处理提交的任务。
2、（0）shutdown: 不接受 新的任务，但会处理已经提交的任务。
3、（1）stop：不接受任务，中断处理的任务。
4、（2）tidying：
5、（3）terminated：处于tidying的状态时，自动调用 terminated()。 
~~~

![image-20220816205607227](C:\Users\CSB7D0\Desktop\mca\typroImage\image-20220816205607227.png)

## 5、什么是工作线程

~~~
1、是一个 work 对象 继承 AQS ,实现 Runable 。
	线程池的执行就是 调用 worker 类的 run() 内部的 runWorker()
	worker 继承 AQS 是为了添加标识来判断当前工作线程是否可以被打断。
~~~

## 6、工作线程存放在

~~~
存放在 一个 HashSet<Worker> 中
~~~

## 7、拒绝策略

~~~
1、Abort：丢弃抛异常
2、Discard：默默丢弃
3、DiscardOldest：扔掉最先加入任务队列的任务
4、CallerRuns：调用者处理任务，性能下降
~~~

## 8、如何在线程池处理前后做额外处理

~~~
1、重写 beforeExecute(Thread t,Runable r)
2、重写 afterExecuter(Runable r,Throwable t)
~~~

## 9、如何处理线程池的大小

~~~
1、根据任务类型
	CPU密集型：cpu内核 + 1
	IO 密集型：cpu内核 * 2
	混合型：将两种任务分开到两个线程池
~~~

## 10、临界资源线程安全

~~~
1、加互斥锁
2、非阻塞的锁 CAS (java 层无锁)
3、不在锁：ThreadLocal + volatile

线程池才会导致 key 被清除 value 还存在，手动 remove value
~~~

![image-20220816212050936](C:\Users\CSB7D0\Desktop\mca\typroImage\image-20220816212050936.png)

## 11、CAS

~~~
1、compare and swap

存在的问题
	ABA 问题	： 追加版本号
	占用资源 ： 按照场景
		1、自旋 过多 挂起线程
		2、
	保证一个数据的安全
~~~

## 12、Lock

## 13、AQS

~~~
CLH + state 
~~~

