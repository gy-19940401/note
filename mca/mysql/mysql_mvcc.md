# MVCC多版本并发控制

~~~text

MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存。

MVCC在 MySQL InnoDB 中的实现主要是为了提高数据库的并发性能，用更好的方式去处理读-写冲突，
    目标  ： 即使有读写冲突时，也能做到不加锁，非阻塞并发读。 < 读不加锁，写乐观锁 >

当前读 ： 读取的记录都是目前数据库中最新的版本
        1、select lock in share mode (共享锁）
        2、select for update         (行级锁)
        3、update,insert,delete      (排他锁)
        
快照读 ： 即不加锁的非阻塞读 ,实现得 基础 是 MVCC -- （行锁的一种变种）
        1、select (MVCC)
~~~

## 1、数据库并发场景

~~~text
    1、读-读：不存在任何问题，也不需要并发控制。
    2、读-写：有线程安全问题，会体现事务隔离性问题，也就是可能遇到，脏读，不可重复读，幻读等。
    3、写-写：有线程安全问题，可能会存在更新丢失问题，比如第一类更新丢失，第二类更新丢失，也会造成一些事务隔离性问题的出现。
~~~

## 2、操作日志

ACID

~~~text
    1、undo log(A)    : 1、保存了事务发生之前的数据的一个版本，可以用于回滚，
                        2、同时可以提供多版本并发控制下的读（MVCC）
    2、redo log(D)    : 防止在发生故障的时间点，尚有脏页未写入磁盘，在重启mysql服务的时候，根据redo log进行 重做，从而达到事务的持久性这一特性。
    3、bin log        : 主要是记录所有的更改数据的语句，可使用 mysql binlog 命令恢复数据; 
                        实现主从同步;
    4、error log      : 主要是记录 启动、运行、停止mysql时 出现的致命问题，系统级别的错误记录
    5、slow query log : 主要是记录所有执行时间超过 long_query_time 的查询或没有使用索引的查询 (SHOW VARIABLES LIKE 'long_%');default 10s
~~~

## 3、实现原理

~~~text
1、记录的隐性字段（多个）
	trx_id --> 事务ID 对于比当前事务ID 大的事务是不可见的。
	版本链 --> 不同事务 || 相同事务 对 同一记录进行修改的时候，导致该记录的 undo 成为一条（记录）链表；修改前后的值
	roll_ptr --> 指向 undo 日志的指针
2、undo log ( 回滚日志 -- 原子性)
3、Read View       : 事务进行快照读操作的时候生产的读视图,同时 维护当前 活跃的 事务ID 信息
                    注意 ： 不是 开启事务的时候
	m_ids          : 生成 Read view 时，当前活跃的事务ID
	min_trx_id     : Min(m_ids)
	max_trx_id     : max(m_ids) + 1
	creater_trx_id : 创建 Read View 时，当前事务ID
	
	访问规则：
		1、当前事务ID == creater_trx_id --> 同一事务产生数据，当前事务可见
		2、当前事务ID < min_trx_id -->能够访问数据
		3、当前事务ID > max_trx_id -->不能访问数据
		4、当前事务ID in m_ids ? 不能访问数据 : 能够访问数据（事务（非活跃）已经提交）
		5、某个版本 对 当前事务不可见，顺着 版本链往前找（直到找不到）第一个 不在 m_ids 中的事务
~~~

## 4、相关问题

### 4.1、RR 是如何在 RC 基础上解决不可重复读的

~~~
    1、事务中快照读的结果非常依赖事务首次出现快照读的地方，
    2、即某个事务中首次出现快照读的地方十分的关键，它可以决定该事务后续快照读结果的能力
~~~

### 4.2 RC,RR级别下的InnoDB快照读有什么不同

~~~
 RR : read view 是第一次生成后，就一直沿用这个 view
 RC : 每次都重新生成一个新的 view
~~~